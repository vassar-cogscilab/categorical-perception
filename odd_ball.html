<!DOCTYPE html>
<html>
  <head>
    <title>Odd Ball Task</title>
    <script src="jspsych-master/jspsych.js"></script>
    <script src="jspsych-master/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-master/plugins/jspsych-image-keyboard-response.js"></script>
    <link rel="stylesheet" href="jspsych-master/css/jspsych.css"></link>
    <style>

    html {
      background-color: #eee;
    }

    .oddball-stim {
      display: inline-block;
      padding: 10px;
      box-shadow: 0 4px 2px 0 rgba(0,0,0,0.5);
      border: 1px solid #ccc;
      margin: 0px 10px;
      background-color: white;
    }
/*
    div.ex1 {
      position: absolute;
      left: 0px;
      }

    div.ex2 {
      position: absolute;
      left: 200px
      }

    div.ex3 {
      position: absolute;
      left: 400px
      }

    div.ex4 {
      position: absolute;
      left: 600px
      }
*/
    </style>
  </head>
  <body></body>

  <script>
  var stim_width_height = 200;
  var stim_padding = 40;
  var min_dot_density = 100;
  var max_dot_density = 2000;
  var min_line_density = 30;
  var max_line_density = 550;
  var dim_a = 0.5;
  var dim_b = 0.5;

  var oddball_iti = 100;

  var rel_bw_distance = 0.2;
  var rel_wi_distance = 0.2;
  var irr_distance = 0.2;

    /* create timeline */
    var timeline = [];

    /* define welcome message trial */
    var welcome = {
      type: "html-keyboard-response",
      stimulus: "Welcome to the experiment. Press any key to begin."
    };
    timeline.push(welcome);

    /* define instructions trial */
    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>In this experiment, four stars will appear in the center" +
      "of the screen. </p><p> If the <strong>first</strong> star from the left is different" +
      "from the others, press 1. </p><p>If the <strong>second</strong> star from the left is different"+
      "from the rest, press 2. </p><p> If the <strong>third</strong> star from the left is different from the rest"+
      "press 3. </p><p> If the <strong>fourth</strong> star from the left is different from the rest, press 4. </p>" +
          "<div style='float: left;'><img src='jspsych-master/img/lineup.png'></img>" +
          "<p class='small'> ex. <strong>Press 3 </strong></p></div>" +
          "<p>Press any key to begin.</p>",
      post_trial_gap: 500,
    };
    timeline.push(instructions);

    /* test trials */
    var pause = {
      type: 'html-keyboard-response',
      stimulus: '',
      choices: jsPsych.NO_KEYS,
      trial_duration: oddball_iti,
      data: {test_part: 'fixation'}
    }

    var test = {
      type: "html-keyboard-response",
      stimulus: '',
      choices: ['1', '2', '3', '4'],
      trial_duration: 4000,
      on_start: function(trial) {
        dimension = relevant_dimension;
        correct = randomize_correct();
        pair = randomize_pair();
        stimulus = calculate_dimension_values(pair, correct, dimension);
        if (pair =='1'||'2'||'3'||'4') {pair_type = 'bw'}
        else if (pair =='5'||'6'||'7'||'8'||'9'||'10'||'11'||'12') {pair_type = 'wi'}
        else {pair_type = 'irr'}
        if(pair_type == 'bw'){
          distance = rel_bw_distance;
        } else if(pair_type == 'wi'){
          distance = rel_wi_distance;
        } else if(pair_type == 'irr'){
          distance = irr_distance;
        }
        trial.stimulus = stimulus;
        trial.data = {test_part: 'test', correct_response: correct}
      },
      on_finish: function(data) {
        data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
        if(pair_type == 'bw'){
          rel_bw_distance = adjust_distance(rel_bw_distance, data.correct);
        } else if(pair_type == 'wi'){
          rel_wi_distance = adjust_distance(rel_wi_distance, data.correct);
        } else if(pair_type == 'irr'){
          irr_distance = adjust_distance(irr_distance, data.correct);
        }
      },
    }

    /* determines which dimension is relevant throughout the experiment */
    var relevant_dimension = jsPsych.randomization.sampleWithoutReplacement(['dots', 'lines'], 1) [0];

    /* determine which sunburst will be the odd-ball */
    function randomize_correct() {
      return jsPsych.randomization.sampleWithoutReplacement(['1', '2', '3', '4'], 1)[0];
    }

    /* determines if the last answer was correct */
    /*function last_correct() {
      return jsPsych.data.get().last(1).values()[0].correct;
    }*/

    /* adjusts the particular distance depending on correctness of the response */
    var three = 0;
    function adjust_distance(distance, correct) {
      if(correct) {three += 1;}
      else {distance *= 1.15;}
      if(three % 3 == 0) {distance *= 0.85;}
      return distance;
    }

    /* randomly generates true or false */
    function boolean() {
      var boolean = jsPsych.randomization.sampleWithoutReplacement([true, false], 1)[0];
      return boolean;
    }

    /* randomly samples a particular pair of sunbursts from the scene */
    function randomize_pair() {
      return jsPsych.randomization.sampleWithoutReplacement(['1', '2', '3', '4', '5', '6', '7', '8', '9'+
                                                            '10', '11', '12', '13', '14', '15, 16', '17' +
                                                            '18', '19', '20', '21', '22', '23', '24'], 1)[0];
    }

    function x1_coordinate(pair) {
      if (pair == '1') {
        x1 = 1;
      } else if (pair == '2') {
        x1 = 1;
      } else if (pair == '3') {
        x1 = 1;
      } else if (pair == '4') {
        x1 = 1;
      } else if (pair == '5') {
        x1 = 0;
      } else if (pair == '6') {
        x1 = 0;
      } else if (pair == '7') {
        x1 = 0;
      } else if (pair == '8') {
        x1 = 0;
      } else if (pair == '9') {
        x1 = 2;
      } else if (pair == '10') {
        x1 = 2;
      } else if (pair == '11') {
        x1 = 2;
      } else if (pair == '12') {
        x1 = 2;
      } else if (pair == '13') {
        x1 = 0;
      } else if (pair == '14') {
        x1 = 0;
      } else if (pair == '15') {
        x1 = 0;
      } else if (pair == '16') {
        x1 = 1;
      } else if (pair == '17') {
        x1 = 1;
      } else if (pair == '18') {
        x1 = 1;
      } else if (pair == '19') {
        x1 = 2;
      } else if (pair == '20') {
        x1 = 2;
      } else if (pair == '21') {
        x1 = 2;
      } else if (pair == '22') {
        x1 = 3;
      } else if (pair == '23') {
        x1 = 3;
      } else {
        x1 = 3;
      }
      return x1;
    }

    function x2_coordinate(pair) {
      if (pair == '1') {
        x2 = 2;
      } else if (pair == '2') {
        x2 = 2;
      } else if (pair == '3') {
        x2 = 2;
      } else if (pair == '4') {
        x2 = 2;
      } else if (pair == '5') {
        x2 = 1;
      } else if (pair == '6') {
        x2 = 1;
      } else if (pair == '7') {
        x2 = 1;
      } else if (pair == '8') {
        x2 = 0;
      } else if (pair == '9') {
        x2 = 3;
      } else if (pair == '10') {
        x2 = 3;
      } else if (pair == '11') {
        x2 = 3;
      } else if (pair == '12') {
        x2 = 3;
      } else if (pair == '13') {
        x2 = 0;
      } else if (pair == '14') {
        x2 = 0;
      } else if (pair == '15') {
        x2 = 0;
      } else if (pair == '16') {
        x2 = 1;
      } else if (pair == '17') {
        x2 = 1;
      } else if (pair == '18') {
        x2 = 1;
      } else if (pair == '19') {
        x2 = 2;
      } else if (pair == '20') {
        x2 = 2;
      } else if (pair == '21') {
        x2 = 2;
      } else if (pair == '22') {
        x2 = 3;
      } else if (pair == '23') {
        x2 = 3;
      } else {
        x2 = 3;
      }
      return x2;
    }

    function y1_coordinate(pair) {
      if (pair == '1') {
        y1 = 3;
      } else if (pair == '2') {
        y1 = 2;
      } else if (pair == '3') {
        y1 = 1;
      } else if (pair == '4') {
        y1 = 0;
      } else if (pair == '5') {
        y1 = 3;
      } else if (pair == '6') {
        y1 = 2;
      } else if (pair == '7') {
        y1 = 1;
      } else if (pair == '8') {
        y1 = 1;
      } else if (pair == '9') {
        y1 = 3;
      } else if (pair == '10') {
        y1 = 2;
      } else if (pair == '11') {
        y1 = 1;
      } else if (pair == '12') {
        y1 = 0;
      } else if (pair == '13') {
        y1 = 3;
      } else if (pair == '14') {
        y1 = 2;
      } else if (pair == '15') {
        y1 = 1;
      } else if (pair == '16') {
        y1 = 3;
      } else if (pair == '17') {
        y1 = 2;
      } else if (pair == '18') {
        y1 = 1;
      } else if (pair == '19') {
        y1 = 3;
      } else if (pair == '20') {
        y1 = 2;
      } else if (pair == '21') {
        y1 = 1;
      } else if (pair == '22') {
        y1 = 3;
      } else if (pair == '23') {
        y1 = 2;
      } else {
        y1 = 1;
      }
      return y1;
    }

    function y2_coordinate(pair) {
      if (pair == '1') {
        y2 = 3;
      } else if (pair == '2') {
        y2 = 2;
      } else if (pair == '3') {
        y2 = 1;
      } else if (pair == '4') {
        y2 = 0;
      } else if (pair == '5') {
        y2 = 3;
      } else if (pair == '6') {
        y2 = 2;
      } else if (pair == '7') {
        y2 = 1;
      } else if (pair == '8') {
        y2 = 0;
      } else if (pair == '9') {
        y2 = 3;
      } else if (pair == '10') {
        y2 = 2;
      } else if (pair == '11') {
        y2 = 1;
      } else if (pair == '12') {
        y2 = 0;
      } else if (pair == '13') {
        y2 = 2;
      } else if (pair == '14') {
        y2 = 1;
      } else if (pair == '15') {
        y2 = 0;
      } else if (pair == '16') {
        y2 = 2;
      } else if (pair == '17') {
        y2 = 1;
      } else if (pair == '18') {
        y2 = 0;
      } else if (pair == '19') {
        y2 = 2;
      } else if (pair == '20') {
        y2 = 1;
      } else if (pair == '21') {
        y2 = 0;
      } else if (pair == '22') {
        y2 = 2;
      } else if (pair == '23') {
        y2 = 1;
      } else {
        y2 = 0;
      }
      return y2;
    }

    function x_dim_val(x, bw, wi){
      var x_dim, y_dim;
      if(x == 0){
        x_dim = 0.5 - (bw/2) - wi;
      } else if(x == 1) {
        x_dim = 0.5 - (bw/2);
      } else if(x == 2) {
        x_dim = 0.5 + (bw/2);
      } else if(x == 3) {
        x_dim = 0.5 + (bw/2) + wi;
      }
      return x_dim;
    }

    function y_dim_val(y, irr) {
      if(y == 0){
        y_dim = 0.5 - (irr/2) - irr;
      } else if(y == 1) {
        y_dim = 0.5 - (irr/2);
      } else if(y == 2) {
        y_dim = 0.5 + (irr/2);
      } else if(y == 3) {
        y_dim = 0.5 + (irr/2) + irr;
      }
      return y_dim;
    }

    function calculate_dimension_values(pair, correct, dimension) {
      var bool = boolean();
      if (bool) {
        sx = x_dim_val(x1_coordinate(pair), rel_bw_distance, rel_wi_distance);
      } else {
        sx = x_dim_val(x2_coordinate(pair), rel_bw_distance, rel_wi_distance);
      }
      sy = y_dim_val(y1_coordinate(pair), irr_distance);
      if (bool) {
        ox = x_dim_val(x2_coordinate(pair), rel_bw_distance, rel_wi_distance);
      } else {
        ox = x_dim_val(x1_coordinate(pair), rel_bw_distance, rel_wi_distance);
      }
      var oy = y_dim_val(y2_coordinate(pair), irr_distance);
      if (dimension == 'dots') {
        set = generate_set(sx, sy, ox, oy, correct);
        return set;
      } else {
        set = generate_set(sy, sx, oy, ox, correct, dimension);
        return set;
      }
    }

    function generate_set(same_dot, same_line, odd_dot, odd_line, correct, dimension) {
      var html = '<div style="position: relative; width:'+((stim_width_height+stim_padding)*4 + stim_padding)+'px; height:'+(stim_width_height+stim_padding)+'px;">';
      if (dimension == 'dots') {
        if (correct == '1'){
          html += '<div class="oddball-stim ex1">'+generate_stim(odd_dot, odd_line)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(same_dot, same_line)+'</div>';
        } else if (correct == '2') {
          html += '<div class="oddball-stim ex1">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(odd_dot, odd_line)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(same_dot, same_line)+'</div>';
        } else if (correct == '3') {
          html += '<div class="oddball-stim ex1">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(odd_dot, odd_line)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(same_dot, same_line)+'</div>';
        } else {
          html += '<div class="oddball-stim ex1">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(same_dot, same_line)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(odd_dot, same_line)+'</div>';
        }
      } else {
        if (correct == '1'){
          html += '<div class="oddball-stim ex1">'+generate_stim(odd_line, odd_dot)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(same_line, same_dot)+'</div>';
        } else if (correct == '2') {
          html += '<div class="oddball-stim ex1">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(odd_line, odd_dot)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(same_line, same_dot)+'</div>';
        } else if (correct == '3') {
          html += '<div class="oddball-stim ex1">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(odd_line, odd_dot)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(same_line, same_dot)+'</div>';
        } else {
          html += '<div class="oddball-stim ex1">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex2">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex3">'+generate_stim(same_line, same_dot)+'</div>'+
            '<div class="oddball-stim ex4">'+generate_stim(odd_line, same_dot)+'</div>';
        }
      }
      html += '</div>';
      return html;
    }

    function generate_stim(dot_dim, line_dim) {
      // params
      var w = stim_width_height;
      var r = stim_width_height/4;
      var x = w / 2;
      var y = w / 2;
      var circle_r = stim_width_height / 200;
      var minLineLength = 10;
      var dot_density = min_dot_density + (max_dot_density-min_dot_density)*dot_dim;
      var line_density = min_line_density + (max_line_density-min_line_density)*line_dim;

      // svg string
      var str = '<svg xmlns="http://www.w3.org/2000/svg" width="' + w + '" height="' + w + '">'

      //Code for drawing the lines that come out of the circle.
      //Each line starts in the center of the circle and is drawn outward
      for (var i = 0; i < line_density; i++) {
        var angle = Math.random() * Math.PI / 2;
        var lineLength = r + minLineLength + (r - minLineLength) * Math.random();
        var x2 = Math.cos(angle) * lineLength;
        var y2 = Math.sin(angle) * lineLength;
        if (Math.random() < 0.5) {
          x2 = -x2;
        }
        if (Math.random() < 0.5) {
          y2 = -y2;
        }
        x2 = x + x2;
        y2 = y + y2;
        str += '<line x1="' + x + '" y1="' + y + '" x2="' + x2 + '" y2="' + y2 + '" style="stroke:rgb(65,105,225); stroke-width:1;" />';
      }

      // draw circle
      str += '<circle cx="' + x + '" cy="' + y + '" r="' + r + '" style="stroke:rgb(65,105,225); stroke-width:2; fill: rgb(255,255,255);"/>'

      //Code for creating and dispersing the dots
      for (var j = 0; j < dot_density; j++) {
        do {
          var x2 = Math.random() * 2 * r + x - r;
          var y2 = Math.random() * 2 * r + y - r;
        } while ((Math.pow(x - x2, 2) + Math.pow(y - y2, 2)) > Math.pow(r - circle_r - 2, 2));
        str += '<circle cx="' + x2 + '" cy="' + y2 + '" r="' + circle_r + '" style="fill:rgb(65,105,225);" />';
      }

      str += "</svg>";

      return str;
    }

    var feedback = {
      type: "html-keyboard-response",
      stimulus: function() {
        var stimulus = jsPsych.data.get().last(1).values()[0].stimulus;
        var correct_response = jsPsych.data.get().last(1).values()[0].correct_response;
        var lastCorrect = jsPsych.data.get().last(1).values()[0].correct;
        var actualResponse = jsPsych.data.get().last(1).values()[0].key_press - 48;
        var html = "<style>"
        html += ".ex"+correct_response+" { border: 11px solid limegreen; padding: 0;} ";
        if(!lastCorrect){
          html += ".ex"+actualResponse+" { border: 11px solid red; padding: 0;} ";
        }
        html += "</style>"
        html += stimulus;
        if(lastCorrect == true){
          //html += "<p>Correct!</p>"
        }
        else {
          //html += "<p>Incorrect!</p>"
        }
        return html;
      },
      choices: jsPsych.NO_KEYS,
      trial_duration: 500
    }

    var test_procedure = {
      timeline: [pause, test, feedback],
      //timeline_variables: test_stimuli,
      repetitions: 20,
      randomize_order: true
    }
    timeline.push(test_procedure);

    var min_dot_density = 100;
    var max_dot_density = 2000;
    var min_line_density = 30;
    var max_line_density = 550;
    var dim_a = 0.5;
    var dim_b = 0.5;

    document.querySelector('body').innerHTML = generate_set(0.5, 0.5);

    /* define debrief */

    var debrief_block = {
      type: "html-keyboard-response",
      stimulus: function() {
        var trials = jsPsych.data.get().filter({test_part: 'test'});
        var correct_trials = trials.filter({correct: true});
        var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
        var rt = Math.round(correct_trials.select('rt').mean());

        return "<p>You responded correctly on "+accuracy+"% of the trials.</p>"+
        "<p>Your average response time was "+rt+"ms.</p>"+
        "<p>Press any key to complete the experiment. Thank you!</p>";
      }
    };
    timeline.push(debrief_block);

    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      on_finish: function() {
        console.log(jsPsych.data.get().ignore('stimulus').json());
      }
    });

  </script>
</html>
